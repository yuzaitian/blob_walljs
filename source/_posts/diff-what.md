---
title: diff算法是什么
date: 2018-03-13 00:02:32
tags:
---
虚拟DOM的表示比较简单，其实对比找出两棵树的差异才是Virtual DOM算法的最核心部分，也就是我们所说的diff算法。

两棵树的完全对比时间复杂度是O(n^3)，这个开销是非常大的，但是我们如果可以只对比两棵树的同层级节点，不去管不能层级的节点差异（因为我们很少跨层级地移动DOM节点），那么时间复杂度就可以降到O(n)，React的diff算法就是这么做的：

<!-- more -->
> 1. DOM节点跨层级的移动操作发生频率很低，是次要矛盾
> 2. 相同的组件产生类似的DOM结构，不同的组件产生不同的DOM结构
> 3. 对于同一层次的一组子节点，可以通过唯一的id(即key)进行区分

### DOM对比差异类型
在实际中，会对两颗虚拟DOM树进行深度优先遍历，并记录差异类型，最终将差异应用到界面上。那都有哪些差异类型呢？

> 1. 替换类型，替换掉原来的节点
> 2. 移动、删除、新增子节点，列表的移动比较难对比出来，于是采取key策略，给同层的每一个DOM一个唯一的key，帮助优化对比；当发现节点已经不存在时，直接删除该节点和所有子节点信息，不再进行比较
> 3. 修改节点属性
> 4. 对于文本节点来说，有可能存在文本内容替换类型

如果真的发生了跨层级移动，React是不会机智的判定出DOM节点只是发生了移动，而是会直接销毁节点，并在另一个地方重新创建这个节点。所以，这也是React官方推荐不要进行跨层级DOM移动的原因，在实际开发中，保持一个稳定的DOM结构有利于提升页面性能。

### Virtual DOM算法总结
> 1. 使用JavaScript对象来表示DOM树结构（虚拟DOM树）
> 2. 状态变化时，构造一颗新的虚拟DOM树，对新旧两棵虚拟DOM树进行深度优先遍历
> 3. 分层寻找差异，只对比同层节点
> 4. 分组件类型寻找差异，相同类型的组件才生成相同的DOM树结构，优化component dirty
> 5. 寻找出所有差异类型，应用到真实的DOM中，完成页面更新